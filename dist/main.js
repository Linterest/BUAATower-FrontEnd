!function(e){var t={};function i(a){if(t[a])return t[a].exports;var s=t[a]={i:a,l:!1,exports:{}};return e[a].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=e,i.c=t,i.d=function(e,t,a){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(a,s,function(t){return e[t]}.bind(null,s));return a},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}([function(e,t,i){"use strict";i.r(t);var a={};i.r(a),i.d(a,"getCurrentTime",function(){return s}),i.d(a,"random",function(){return n}),i.d(a,"randomPositiveNegative",function(){return r}),i.d(a,"isFunction",function(){return o}),i.d(a,"isTouchDevice",function(){return h}),i.d(a,"requestAnimationFrameTool",function(){return c}),i.d(a,"arraySwap",function(){return l});const s=()=>performance.now(),n=(e,t)=>Math.random()*(t-e)+e,r=()=>Math.random()<.5?-1:1,o=e=>"function"==typeof e,h=()=>"ontouchstart"in window||window.navigator.msMaxTouchPoints,c=(()=>{let e=1e3/60;return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||(t=>{window.setTimeout(()=>{const i=s();t(i);const a=s();e=1e3/60-(a-i)},e)})})(),l=(e,t,i)=>{const a=e[i];e[i]=e[t],e[t]=a};var d={linear:function(e,t,i,a){return i*e/a+t},easeIn:function(e,t,i,a){return i*(e/=a)*e+t},easeOut:function(e,t,i,a){return-i*(e/=a)*(e-2)+t},easeInOut:function(e,t,i,a){return(e/=a/2)<1?i/2*e*e+t:-i/2*(--e*(e-2)-1)+t}};const{requestAnimationFrameTool:u,isFunction:g,isTouchDevice:m}=a;class b{constructor(e={}){const{name:t,painter:i,action:a,trigger:s}=e;this.name=t,this.x=0,this.y=0,this.width=0,this.height=0,this.ax=0,this.ay=0,this.vx=0,this.vy=0,this.visible=!0,this.painter=i||null,this.action=a||null,this.trigger=s||null,this.ready=!1}paint(e){null!==this.painter&&this.visible&&this.painter(this,e)}update(e,t){null!==this.action&&this.action(this,e,t)}updateWidth(e){this.width=e,this.calWidth=e/2}updateHeight(e){this.height=e,this.calHeight=e/2}}var f="LAND",y="OUT",T=function(e){return e.checkTimeMovement("MOVE_DOWN_MOVEMENT")},p=function(e,t){var i=t?t.pixelsPerFrame:e.pixelsPerFrame.bind(e),a=e.getVariable("SUCCESS_COUNT"),s=2*e.getVariable("BLOCK_HEIGHT");return i(a<=4?1.25*s:s)},v=function(e,t){var i,a=e.getVariable("SUCCESS_COUNT"),s=e.getVariable("GAME_SCORE"),n=e.getVariable("GAME_USER_OPTION").hookSpeed;if(n)return n(a,s);switch(!0){case a<1:i=0;break;case a<10:i=1;break;case a<20:i=.8;break;case a<30:i=.7;break;default:i=.74}return e.getVariable("HARD_MODE")&&(i=1.1),Math.sin(t/(200/i))},O=function(e,t){var i=e.getVariable("SUCCESS_COUNT"),a=e.getVariable("GAME_SCORE"),s=e.getVariable("GAME_USER_OPTION").landBlockSpeed;if(s)return s(i,a);var n,r=e.width;switch(!0){case i<5:n=0;break;case i<13:n=.001;break;case i<23:n=.002;break;default:n=.003}return Math.cos(t/200)*n*r},E=function(e){return e.checkTimeMovement("HOOK_DOWN_MOVEMENT")?"HOOK_DOWN":e.checkTimeMovement("HOOK_UP_MOVEMENT")?"HOOK_UP":"HOOK_NORMAL"},x=function(e){var t=e.getVariable("GAME_USER_OPTION").setGameFailed,i=e.getVariable("FAILED_COUNT")+1;if(e.setVariable("FAILED_COUNT",i),e.setVariable("PERFECT_COUNT",0),t&&t(i),i>=3){console.log("失败开始画图"),e.pauseAudio("bgm"),e.playAudio("game-over"),e.setVariable("GAME_START_NOW",!1);var a=document.getElementById("bg"),s=document.getElementById("qrc");console.log("bg==>>>",a);var n=document.getElementById("imgX");if(console.log("eleImgX==>>>",n),score<1960)a=document.getElementById("bg1");else if(score<1968&&score>=1960)a=document.getElementById("bg2");else if(score<1976&&score>=1968)a=document.getElementById("bg3");else if(score<1984&&score>=1976)a=document.getElementById("bg4");else if(score<1992&&score>=1984)a=document.getElementById("bg5");else if(score<2e3&&score>=1992)a=document.getElementById("bg6");else if(score<2008&&score>=2e3)a=document.getElementById("bg7");else if(score<2018&&score>=2008)a=document.getElementById("bg8");else a=document.getElementById("bg9");console.log("eleImgX",n),console.log("bg==>>>",a);var r=document.createElement("canvas");r.height=1920,r.width=1080;var o=r.getContext("2d");o.drawImage(a,0,0,1080,1920),o.drawImage(s,885,1641,150,150),o.font="bold 50px wenxue",o.fillStyle="#c4191f",o.fillText(len,882,160),console.log("number===>>len"),o.font="bold 50px wenxue",o.fillStyle="#797477",o.fillText(nickname,150,560),console.log("nickname===>>nickname"),o.font="270px bold",o.fillStyle="#f5cc46",o.strokeStyle="white",o.lineWidth=30,successCount>9?(o.strokeText(successCount,370,1030),o.fillText(successCount,370,1030)):(o.strokeText(successCount,460,1030),o.fillText(successCount,460,1030)),console.log("successCount===>>66"),o.fillStyle="white",o.font="bold 50px wenxue",o.translate(770,1105),o.rotate(-Math.PI/10),o.fillText(amount,0,0),console.log("总层数=======>amount");var h=r.toDataURL("image/png",.8);n.innerHTML='<img src="'+h+'"width="70%" height="100%"box-shadow=" 0 0 1px #000">',console.log("eleImgX",n)}},w=function(e,t){var i=e.getVariable("GAME_USER_OPTION"),a=i.setGameScore,s=i.successScore,n=i.perfectScore,r=e.getVariable("PERFECT_COUNT",0),o=e.getVariable("GAME_SCORE",1950),h=t?r+1:0,c=parseInt(o+.08*((s||25)+(n||25)*h))>=2018?"2018":parseInt(o+.08*((s||25)+(n||25)*h));e.setVariable("GAME_SCORE",c),e.setVariable("PERFECT_COUNT",h),a&&a(c)},I=function(e,t){var i=t.string,a=t.size,s=t.x,n=t.y,r=t.textAlign,o=e.ctx,h=a,c=.1*h;o.save(),o.beginPath();var l=o.createLinearGradient(0,0,0,n);l.addColorStop(0,"#FAD961"),l.addColorStop(1,"#F76B1C"),o.fillStyle=l,o.lineWidth=c,o.strokeStyle="#FFF",o.textAlign=r||"center",o.font="".concat(h,"px ").concat("wenxue"),o.strokeText(i,s,n),o.fillText(i,s,n),o.restore()},_=function(e,t,i){var a=t+1>=e.length?e.length-1:t,s=e[a],n=e[a+1>=e.length-1?a:a+1],r=function(e){var t=s[e],a=n[e];return Math.round(t+(a-t)*i)};return"rgb(".concat(r(0),", ").concat(r(1),", ").concat(r(2),")")},M=function(e){!function(e){var t=e.ctx.createLinearGradient(0,0,0,e.height),i=[[200,255,150],[105,230,240],[90,190,240],[85,100,190],[55,20,35],[75,25,35],[25,0,10]],a=e.getVariable("BACKGROUND_LINEAR_GRADIENT_OFFSET_HEIGHT",0);T(e)&&e.setVariable("BACKGROUND_LINEAR_GRADIENT_OFFSET_HEIGHT",a+1.5*p(e));var s=parseInt(a/e.height,10),n=a%e.height/e.height,r=_(i,s,n),o=_(i,s+1,n);t.addColorStop(0,o),t.addColorStop(1,r),e.ctx.fillStyle=t,e.ctx.beginPath(),e.ctx.rect(0,0,e.width,e.height),e.ctx.fill();var h=function(){e.ctx.fillStyle="rgba(255, 255, 255, 0.7)",e.ctx.fillRect(0,0,e.width,e.height)};e.getTimeMovement("LIGHTNING_MOVEMENT",[],function(){},{before:h,after:h})}(e),function(e){var t=e.getImg("background"),i=t.width,a=t.height*e.width/i,s=e.getVariable("BACKGROUND_IMG_OFFSET_HEIGHT",e.height-a);s>e.height||(e.getTimeMovement("MOVE_DOWN_MOVEMENT",[[s,s+p(e,{pixelsPerFrame:function(e){return e/2}})]],function(e){s=e},{name:"background"}),e.getTimeMovement("BG_INIT_MOVEMENT",[[s,s+a/4]],function(e){s=e}),e.setVariable("BACKGROUND_IMG_OFFSET_HEIGHT",s),e.setVariable("LINE_INITIAL_OFFSET",e.height-.394*a),e.ctx.drawImage(t,0,s,e.width,a))}(e)},A=function(e,t,i){var a=e;a.ready||(a.y=t.getVariable("LINE_INITIAL_OFFSET"),a.ready=!0,a.collisionX=t.width-t.getVariable("BLOCK_WIDTH")),t.getTimeMovement("MOVE_DOWN_MOVEMENT",[[e.y,e.y+p(t,{pixelsPerFrame:function(e){return e/2}})]],function(t){e.y=t},{name:"line"});var s=O(t,i);e.x+=s,e.collisionX+=s},L=function(e,t){var i=t.ctx;t.debug&&(i.save(),i.beginPath(),i.strokeStyle="red",i.moveTo(e.x,e.y),i.lineTo(e.collisionX,e.y),i.lineWidth=1,i.stroke(),i.restore())},k=function(e){var t=e.count,i=function(e){return e[Math.floor(Math.random()*e.length)]};e.imgName=i(t>6?["c4","c5","c6","c7","c8"]:["c1","c2","c3"])},N=function(e,t){if(!e.ready){e.ready=!0,k(e),e.width=t.getVariable("CLOUD_SIZE"),e.height=t.getVariable("CLOUD_SIZE");var i=t.width,a=t.height,s=[{x:.1*i,y:.66*-a},{x:.65*i,y:.33*-a},{x:.1*i,y:0},{x:.65*i,y:.33*a}][e.index-1];e.x=t.utils.random(s.x,1.2*s.x),e.originX=e.x,e.ax=t.pixelsPerFrame(e.width*t.utils.random(.05,.08)*t.utils.randomPositiveNegative()),e.y=t.utils.random(s.y,1.2*s.y)}e.x+=e.ax,(e.x>=e.originX+e.width||e.x<=e.originX-e.width)&&(e.ax*=-1),T(t)&&(e.y+=1.2*p(t)),e.y>=t.height&&(e.y=.66*-t.height,e.count+=4,k(e))},C=function(e,t){var i=t.ctx,a=t.getImg(e.imgName);i.drawImage(a,e.x,e.y,e.width,e.height)},S=function(e,t,i){var a=t.getVariable("ROPE_HEIGHT");e.ready||(e.x=t.width/2,e.y=-1.5*a,e.ready=!0),t.getTimeMovement("HOOK_UP_MOVEMENT",[[e.y,e.y-a]],function(t){e.y=t},{after:function(){e.y=-1.5*a}}),t.getTimeMovement("HOOK_DOWN_MOVEMENT",[[e.y,e.y+a]],function(t){e.y=t},{name:"hook"});var s=t.getVariable("INITIAL_ANGLE");e.angle=s*v(t,i),e.weightX=e.x+Math.sin(e.angle)*a,e.weightY=e.y+Math.cos(e.angle)*a},V=function(e,t){var i=t.ctx,a=t.getVariable("ROPE_HEIGHT"),s=.1*a,n=t.getImg("hook");i.save(),i.translate(e.x,e.y),i.rotate(2*Math.PI-e.angle),i.translate(-e.x,-e.y),t.ctx.drawImage(n,e.x-s/2,e.y,s,a+5),i.restore()},R=function(e,t,i){var a=t.width,s=t.height,n=e.name;if(!e.ready){e.ready=!0;var r=.2*a;e.updateWidth(r),e.height=.46*r,e.x=t.calWidth-e.calWidth,e.y=.45*s,"tutorial"!==n&&(e.y+=1.2*e.height)}"tutorial"!==n&&(e.y+=Math.cos(i/200)*e.height*.01)},P=function(e,t){if(!t.checkTimeMovement("TUTORIAL_MOVEMENT")&&"HOOK_NORMAL"===E(t)){var i=t.ctx,a=e.name,s=t.getImg(a);i.drawImage(s,e.x,e.y,e.width,e.height)}},F=function(e,t){"ROTATE_LEFT"===e.status?e.y-e.width>=t.height&&(e.visible=!1,e.status=y,x(t)):e.y>=t.height&&(e.visible=!1,e.status=y,x(t))},D=function(e,t,i){var a=e,s=t.getVariable("ROPE_HEIGHT");if(a.visible){a.ready||(a.ready=!0,a.status="SWING",e.updateWidth(t.getVariable("BLOCK_WIDTH")),e.updateHeight(t.getVariable("BLOCK_HEIGHT")),e.x=t.width/2,e.y=-1.5*s);var n=t.getInstance("line");switch(a.status){case"SWING":t.getTimeMovement("HOOK_DOWN_MOVEMENT",[[e.y,e.y+s]],function(t){e.y=t},{name:"block"}),function(e,t,i){var a=t.getVariable("ROPE_HEIGHT");if("SWING"===e.status){var s=e,n=t.getVariable("INITIAL_ANGLE");s.angle=n*v(t,i),s.weightX=s.x+Math.sin(s.angle)*a,s.weightY=s.y+Math.cos(s.angle)*a}}(e,t,i);break;case"BEFORE_DROP":a.x=e.weightX-e.calWidth,a.y=e.weightY+.3*e.height,a.rotate=0,a.ay=t.pixelsPerFrame(3e-4*t.height),a.startDropTime=i,a.status="DROP";break;case"DROP":var r=i-a.startDropTime;a.startDropTime=i,a.vy+=a.ay*r,a.y+=a.vy*r+.5*a.ay*Math.pow(r,2);var o=function(e,t){return e.y+e.height>=t.y?e.x<t.x-e.calWidth||e.x>t.collisionX+e.calWidth?1:e.x<t.x?2:e.x>t.collisionX?3:e.x>t.x+.8*e.calWidth&&e.x<t.x+1.2*e.calWidth?5:4:0}(e,n),h=n.y-e.height,c=function(e){e.originOutwardAngle=Math.atan(e.height/e.outwardOffset),e.originHypotenuse=Math.sqrt(Math.pow(e.height,2)+Math.pow(e.outwardOffset,2)),t.playAudio("rotate")};switch(o){case 1:F(e,t);break;case 2:a.status="ROTATE_LEFT",e.y=h,e.outwardOffset=n.x+e.calWidth-e.x,c(e);break;case 3:a.status="ROTATE_RIGHT",e.y=h,e.outwardOffset=n.collisionX+e.calWidth-e.x,c(e);break;case 4:case 5:a.status=f;var l=t.getVariable("SUCCESS_COUNT");!function(e){var t=e.getVariable("GAME_USER_OPTION").setGameSuccess,i=e.getVariable("SUCCESS_COUNT")+1;e.setVariable("SUCCESS_COUNT",i),e.getVariable("HARD_MODE")&&e.setVariable("ROPE_HEIGHT",e.height*e.utils.random(.35,.55)),t&&t(i)}(t),t.setTimeMovement("MOVE_DOWN_MOVEMENT",500),10!==l&&15!==l||t.setTimeMovement("LIGHTNING_MOVEMENT",150),e.y=h,n.y=h,n.x=a.x-a.calWidth,n.collisionX=n.x+a.width;var d=.3*a.width;(a.x>t.width-2*d||a.x<-d)&&t.setVariable("HARD_MODE",!0),5===o?(e.perfect=!0,w(t,!0),t.playAudio("drop-perfect")):(w(t),t.playAudio("drop"))}break;case f:t.getTimeMovement("MOVE_DOWN_MOVEMENT",[[e.y,e.y+p(t,{pixelsPerFrame:function(e){return e/2}})]],function(i){e.visible&&(e.y=i,e.y>t.height&&(e.visible=!1))},{name:e.name}),e.x+=O(t,i);break;case"ROTATE_LEFT":case"ROTATE_RIGHT":var u="ROTATE_RIGHT"===a.status,g=t.pixelsPerFrame(4*Math.PI),m=u?e.rotate>1.3:e.rotate<-1.3,b=u?1:-1;if(m)e.rotate+=g/8*b,e.y+=t.pixelsPerFrame(.7*t.height),e.x+=t.pixelsPerFrame(.3*t.width)*b;else{var y=(e.calWidth-e.outwardOffset)/e.calWidth;y=y>.5?y:.5,e.rotate+=g*y*b;var T=e.originOutwardAngle+e.rotate,E=u?n.collisionX+e.calWidth:n.x+e.calWidth,x=n.y;e.x=E-Math.cos(T)*e.originHypotenuse,e.y=x-Math.sin(T)*e.originHypotenuse}F(e,t)}}},G=function(e,t){var i=e.perfect,a=t.getImg(i?"block-perfect":"block");t.ctx.drawImage(a,e.x,e.y,e.width,e.height)},H=function(e,t){switch(e.status){case"SWING":!function(e,t){var i=t.getImg("blockRope");t.ctx.drawImage(i,e.weightX-e.calWidth,e.weightY,e.width,1.3*e.height);var a=e.weightX-e.calWidth;t.debugLineY(a)}(e,t);break;case"DROP":case f:G(e,t);break;case"ROTATE_LEFT":case"ROTATE_RIGHT":!function(e,t){var i=t.ctx;i.save(),i.translate(e.x,e.y),i.rotate(e.rotate),i.translate(-e.x,-e.y),G(e,t),i.restore()}(e,t)}},U=function(e,t){var i=e.visible,a=e.ready,s=e.type;if(i){var n=t.getVariable("CLOUD_SIZE");if(!a){var r=function(e,t){var i=e.width,a=e.height,s=e.utils.random,n=e.getVariable("CLOUD_SIZE");return{bottomToTop:{x:i*s(.3,.7),y:a,vx:0,vy:.7*e.pixelsPerFrame(a)*-1},leftToRight:{x:-1*n,y:a*s(.3,.6),vx:.4*e.pixelsPerFrame(i),vy:.1*e.pixelsPerFrame(a)*-1},rightToLeft:{x:i,y:a*s(.2,.5),vx:.4*e.pixelsPerFrame(i)*-1,vy:.1*e.pixelsPerFrame(a)},rightTopToLeft:{x:i,y:0,vx:.6*e.pixelsPerFrame(i)*-1,vy:.5*e.pixelsPerFrame(a)}}[t]}(t,s);e.ready=!0,e.width=n,e.height=n,e.x=r.x,e.y=r.y,e.vx=r.vx,e.vy=r.vy}e.x+=e.vx,e.y+=e.vy,(e.y+n<0||e.y>t.height||e.x+n<0||e.x>t.width)&&(e.visible=!1)}},W=function(e,t){var i=t.ctx,a=t.getImg(e.imgName);i.drawImage(a,e.x,e.y,e.width,e.height)},B=function(e,t,i){if(e.getVariable("FLIGHT_COUNT")!==t){var a=new b({name:"flight_".concat(t),action:U,painter:W});a.imgName="f".concat(t),a.type=i,e.addInstance(a,"FLIGHT_LAYER"),e.setVariable("FLIGHT_COUNT",t)}},K=function(e){if(e.getVariable("GAME_START_NOW")){var t=e.getVariable("SUCCESS_COUNT",0),i=e.getVariable("FAILED_COUNT"),a=e.getVariable("GAME_SCORE",0),s=Number(t)>99?.1*e.width:0;I(e,{string:"层",size:.06*e.width,x:.24*e.width+s,y:.12*e.width,textAlign:"left"}),I(e,{string:t,size:.17*e.width,x:.22*e.width+s,y:.2*e.width,textAlign:"right"});var n=e.getImg("score"),r=n.width,o=n.height,h=.35*e.width,c=o*h/r;e.ctx.drawImage(n,.61*e.width,.038*e.width,h,c),I(e,{string:a,size:.06*e.width,x:.9*e.width,y:.11*e.width,textAlign:"right"});for(var l=e.ctx,d=e.getImg("heart"),u=d.width,g=d.height,m=.08*e.width,b=g*m/u,f=1;f<=3;f+=1)l.save(),f<=i&&(l.globalAlpha=.2),l.drawImage(d,.66*e.width+(f-1)*m,.16*e.width,m,b),l.restore()}},j=function(e){if(e.getVariable("GAME_START_NOW")){var t=e.getInstance("block_".concat(e.getVariable("BLOCK_COUNT")));if(!t||[f,y].indexOf(t.status)>-1){if(T(e)&&p(e))return;if(e.checkTimeMovement("HOOK_UP_MOVEMENT"))return;var i=function(e){var t=e.getVariable("SUCCESS_COUNT"),i=e.getVariable("GAME_SCORE"),a=e.getVariable("GAME_USER_OPTION").hookAngle;if(a)return a(t,i);if(e.getVariable("HARD_MODE"))return 90;switch(!0){case t<10:return 30;case t<20:return 60;default:return 80}}(e),a=Math.PI*e.utils.random(i,i+5)*e.utils.randomPositiveNegative()/180;e.setVariable("BLOCK_COUNT",e.getVariable("BLOCK_COUNT")+1),e.setVariable("INITIAL_ANGLE",a),e.setTimeMovement("HOOK_DOWN_MOVEMENT",500);var s=new b({name:"block_".concat(e.getVariable("BLOCK_COUNT")),action:D,painter:H});e.addInstance(s)}switch(Number(e.getVariable("SUCCESS_COUNT",0))){case 2:B(e,1,"leftToRight");break;case 6:B(e,2,"rightToLeft");break;case 8:B(e,3,"leftToRight");break;case 14:B(e,4,"bottomToTop");break;case 18:B(e,5,"bottomToTop");break;case 22:B(e,6,"bottomToTop");break;case 25:B(e,7,"rightTopToLeft")}}};window.TowerGame=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.width,i=e.height,s=new class{constructor(e={}){if(!document.createElement("canvas").getContext)return void window.alert("HTML5 Canvas is not supported in your browser.");const{canvasId:t,debug:i,width:s,height:n,highResolution:r,loadLimit:o,soundOn:h}=e;let c=s||window.innerWidth,l=n||window.innerHeight;this.canvas=document.getElementById(t),r&&(this.canvas.style.width=`${c}px`,this.canvas.style.height=`${l}px`,c*=2,l*=2),this.highResolution=r,this.canvas.width=c,this.canvas.height=l,this.width=this.canvas.width,this.height=this.canvas.height,this.calWidth=.5*this.width,this.calHeight=.5*this.height,this.debug=!!i,this.ctx=this.canvas.getContext("2d"),this.defaultLayer="default",this.layerArr=[this.defaultLayer],this.instancesObj={},this.instancesObj[this.defaultLayer]=[],this.instancesReactionArr=[],this.utils=a,this.customVariable={};const d=this;this.isTouchDevice=m(),this.debugArr=[],this.assetsObj={image:{},audio:{}},this.assetsCount={image:0,audio:0},this.assetsErrorQueue=[],this.assetsErrorCount=0,this.loadLimit=o||3,this.soundOn=!!h,this.fps=0,this.lastTime=0,this.lastPausedAt=0,this.pausedTime=0,this.paused=!1,this.timeMovement={},this.timeMovementStartArr=[],this.timeMovementFinishArr=[],this.keyUpListeners={},this.keyDownListeners={},this.keyPressListeners={},this.startAnimate=(()=>{}),this.paintUnderInstance=(()=>{}),this.paintAboveInstance=(()=>{}),this.endAnimate=(()=>{}),this.touchStartListener=(()=>{}),this.touchEndListener=(()=>{}),this.touchMoveListener=(()=>{}),document.addEventListener("keyup",e=>{d.keyListener(e,"keyup")},!1),document.addEventListener("keydown",e=>{d.keyListener(e,"keydown")},!1),document.addEventListener("keypress",e=>{d.keyListener(e,"keypress")},!1),this.isTouchDevice?(document.addEventListener("touchstart",e=>{d.touchStartListener(e)},!1),document.addEventListener("touchend",e=>{d.touchEndListener(e)},!1),document.addEventListener("touchmove",e=>{d.touchMoveListener(e)},!1)):(document.addEventListener("mousedown",e=>{d.touchStartListener(e)},!1),document.addEventListener("mouseup",e=>{d.touchEndListener(e)},!1),document.addEventListener("mousemove",e=>{d.touchMoveListener(e)},!1))}triggerReaction(e,t){let i=e,a=t;this.highResolution&&(i*=2,a*=2),this.instancesReactionArr.forEach(e=>{e.visible&&i>=e.x&&i<=e.x+e.width&&a>=e.y&&a<=e.y+e.height&&e.trigger(e,this)})}addAudio(e,t,i=0){if(!this.soundOn)return;i||(this.assetsCount.audio+=1);const a=new window.Audio;a.src=t,this.assetsObj.audio[e]=a,a.addEventListener("error",()=>{this.assetsErrorQueue.push({name:e,src:t,retry:i+1,type:"audio"})},!1),a.load()}getAudio(e){return this.assetsObj.audio[e]}playAudio(e,t=!1){if(!this.soundOn)return;const i=this.getAudio(e);if(i){if(i.play(),!t)return;i.addEventListener("ended",()=>{i.currentTime=0,i.play()},!1)}}pauseAudio(e){const t=this.getAudio(e);t&&t.pause()}setVariable(e,t){this.customVariable[e]=t}getVariable(e,t=null){const i=this.customVariable[e];return i||(null!==t?(this.setVariable(e,t),t):null)}addImg(e,t,i=0){i||(this.assetsCount.image+=1);const a=new window.Image;a.src=t,a.onload=(()=>{this.assetsObj.image[e]=a}),a.onerror=(()=>{this.assetsErrorQueue.push({name:e,src:t,retry:i+1,type:"image"})})}getImg(e){return this.assetsObj.image[e]}animate(e){const t=e-this.pausedTime,i=this;this.paused?setTimeout(()=>{this.animate.call(i,t)},100):(this.tick(t),this.clean(),this.startAnimate(this,t),this.paintUnderInstance(this),this.updateInstances(t),this.paintInstances(),this.paintAboveInstance(),this.endAnimate(this,t),this.tickTimeMovement(),this.debug&&this.showFps(),this.debug&&this.drawDebug(),u(e=>{this.animate.call(i,e)}))}showFps(){this.ctx.save(),this.ctx.fillStyle="red",this.ctx.font=`${this.highResolution?32:16}px Arial`,this.ctx.fillText(`FPS: ${this.fps.toFixed()}`,5,this.highResolution?40:20),this.ctx.restore()}debugLineX(e){this.debugArr.push({type:"lineX",y:e})}debugLineY(e){this.debugArr.push({type:"lineY",x:e})}debugDot(e,t){this.debugArr.push({type:"dot",x:e,y:t})}drawDebug(){this.debugArr.forEach(e=>{const{type:t,x:i,y:a}=e;switch(t){case"dot":this.drawDebugDot(i,a);break;case"lineX":this.drawDebugLine(null,a);break;case"lineY":this.drawDebugLine(i,null)}}),this.instancesReactionArr.forEach(e=>{e.visible&&(this.ctx.strokeStyle="red",this.ctx.beginPath(),this.ctx.rect(e.x,e.y,e.width,e.height),this.ctx.stroke())})}drawDebugLine(e,t){let i=[0,t],a=[this.width,t];e&&(i=[e,0],a=[e,this.height]),this.ctx.save(),this.ctx.strokeStyle="red",this.ctx.beginPath(),this.ctx.moveTo(...i),this.ctx.lineTo(...a),this.ctx.stroke(),this.ctx.restore()}drawDebugDot(e,t){this.ctx.save(),this.ctx.fillStyle="red",this.ctx.beginPath(),this.ctx.arc(e,t,2,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.fillStyle="white",this.ctx.beginPath(),this.ctx.arc(e,t,1,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.restore()}tick(e){this.updateFps(e),this.lastTime=e}updateFps(e){0===this.lastTime?this.fps=60:this.fps=1e3/(e-this.lastTime)}pixelsPerFrame(e){return e/this.fps}tickTimeMovement(){this.timeMovementStartArr.forEach(e=>{this.timeMovement[e].processing=!0}),this.timeMovementStartArr=[],this.timeMovementFinishArr.forEach(e=>{delete this.timeMovement[e]}),this.timeMovementFinishArr=[]}getTimeMovement(e,t,i,a={}){const{before:s,after:n}=a,r=d[a.easing||"linear"],o=a.name||"default",h=this.timeMovement[e];if(!h)return;h.processing||(this.timeMovementStartArr.push(e),h.store[o]=[],t.forEach(e=>{h.store[o].push({start:parseFloat(e[0]),end:parseFloat(e[1])})}),s&&s());const c=(e=!1)=>{const{duration:t}=h;let a=t;if(!e){const e=this.utils.getCurrentTime(),{startTime:t}=h;a=e-t}const s=h.store[o].map(e=>r(a,e.start,e.end-e.start,t));i.apply(this,s)};this.checkTimeMovement(e)?c():(this.timeMovementFinishArr.push(e),c(!0),n&&n())}checkTimeMovement(e){const t=this.timeMovement[e]||{};return this.utils.getCurrentTime()<=t.endTime}setTimeMovement(e,t){const i=this.utils.getCurrentTime();this.timeMovement[e]={startTime:i,endTime:i+t,duration:t,store:{}}}clean(){this.ctx.clearRect(0,0,this.width,this.height),this.debugArr=[]}addLayer(e){this.layerArr.push(e),this.instancesObj[e]=[]}removeLayer(e){this.layerArr=this.layerArr.filter(t=>t!==e),delete this.instancesObj[e]}swapLayer(e,t){this.utils.arraySwap(this.layerArr,e,t)}addInstance(e,t=this.defaultLayer){this.instancesObj[t].push(e),e.trigger&&this.instancesReactionArr.push(e)}getInstance(e,t=this.defaultLayer){return this.instancesObj[t].filter(t=>t.name===e)[0]}removeInstance(e,t=this.defaultLayer){const i=this.getInstance(e,t);i&&(this.instancesObj[t]=this.instancesObj[t].filter(t=>t.name!==e),i.trigger&&(this.instancesReactionArr=this.instancesReactionArr.filter(t=>t.name!==e)))}updateInstances(e){this.layerArr.forEach(t=>{this.instancesObj[t].forEach(t=>{t.update&&t.update(this,e)})})}paintInstances(){this.layerArr.forEach(e=>{this.instancesObj[e].forEach(e=>{e.paint&&e.paint(this)})})}togglePaused(){const e=this.utils.getCurrentTime();this.paused=!this.paused,this.paused?this.lastPausedAt=e:this.pausedTime+=e-this.lastPausedAt}addKeyUpListener(e,t){this.keyUpListeners[e]=t}addKeyDownListener(e,t){this.keyDownListeners[e]=t}addKeyPressListener(e,t){this.keyPressListeners[e]=t}findKeyListener(e,t){return"keyup"===t?this.keyUpListeners[e]:"keydown"===t?this.keyDownListeners[e]:this.keyPressListeners[e]}keyListener(e,t){let i;switch(e.keyCode){case 13:i="enter";break;case 32:i="space";break;case 37:i="leftArrow";break;case 39:i="rightArrow";break;case 38:i="upArrow";break;case 40:i="downArrow";break;default:i=e.keyCode}const a=this.findKeyListener(i,t);a&&a()}load(e,t){const i=setInterval(()=>{const a=this.assetsCount.image+this.assetsCount.audio,s=Object.keys(this.assetsObj.image).length+Object.keys(this.assetsObj.audio).length;t&&g(t)&&t({success:s,failed:this.assetsErrorCount,total:a}),this.assetsErrorQueue.length>0&&(this.assetsErrorQueue.forEach(e=>{const{retry:t,name:i,src:a,type:s}=e;t>=this.loadLimit?this.assetsErrorCount+=1:"image"===s?this.addImg(i,a,t):this.addAudio(i,a,t)}),this.assetsErrorQueue=[]),s===a&&(e&&g(e)?e():this.init(),clearInterval(i))},200)}init(){const e=this;u(t=>{this.animate.call(e,t)})}}({canvasId:e.canvasId,highResolution:!0,width:t,height:i,soundOn:e.soundOn}),n=function(e){return"./assets/".concat(e)},r=new Array;r[0]="block1.png",r[1]="block2.png",r[2]="block3.png",r[3]="block4.png",r[4]="block5.png",r[5]="block6.png",r[6]="block7.png";var o=Math.random()*r.length;o=Math.floor(o),s.addImg("background",n("background.png")),s.addImg("hook",n("hook.png")),s.addImg("blockRope",n("rope-"+r[o])),s.addImg("block",n(r[o])),s.addImg("block-perfect",n("perfect-"+r[o]));for(var h=1;h<=8;h+=1)s.addImg("c".concat(h),n("c".concat(h,".png")));s.addLayer("FLIGHT_LAYER");for(var c=1;c<=7;c+=1)s.addImg("f".concat(c),n("f".concat(c,".png")));s.swapLayer(0,1),s.addImg("tutorial",n("tutorial.png")),s.addImg("tutorial-arrow",n("tutorial-arrow.png")),s.addImg("heart",n("heart.png")),s.addImg("score",n("score.png")),s.addAudio("drop-perfect",n("drop-perfect.mp3")),s.addAudio("drop",n("drop.mp3")),s.addAudio("game-over",n("game-over.mp3")),s.addAudio("rotate",n("rotate.mp3")),s.addAudio("bgm",n("bgm.mp3")),s.setVariable("BLOCK_WIDTH",.25*s.width),s.setVariable("BLOCK_HEIGHT",.71*s.getVariable("BLOCK_WIDTH")),s.setVariable("CLOUD_SIZE",.3*s.width),s.setVariable("ROPE_HEIGHT",.4*s.height),s.setVariable("BLOCK_COUNT",0),s.setVariable("SUCCESS_COUNT",0),s.setVariable("FAILED_COUNT",0),s.setVariable("GAME_SCORE",0),s.setVariable("HARD_MODE",!1),s.setVariable("GAME_USER_OPTION",e);for(var l=1;l<=4;l+=1){var f=new b({name:"cloud_".concat(l),action:N,painter:C});f.index=l,f.count=5-l,s.addInstance(f)}var y=new b({name:"line",action:A,painter:L});s.addInstance(y);var T=new b({name:"hook",action:S,painter:V});return s.addInstance(T),s.startAnimate=j,s.endAnimate=K,s.paintUnderInstance=M,s.addKeyDownListener("enter",function(){s.debug&&s.togglePaused()}),s.touchStartListener=function(){!function(e){if(e.getVariable("GAME_START_NOW")&&!(e.debug&&e.paused||"HOOK_NORMAL"!==E(e))){e.removeInstance("tutorial"),e.removeInstance("tutorial-arrow");var t=e.getInstance("block_".concat(e.getVariable("BLOCK_COUNT")));t&&"SWING"===t.status&&(e.setTimeMovement("HOOK_UP_MOVEMENT",500),t.status="BEFORE_DROP")}}(s)},s.playBgm=function(){s.playAudio("bgm",!0)},s.pauseBgm=function(){s.pauseAudio("bgm")},s.start=function(){var e=new b({name:"tutorial",action:R,painter:P});s.addInstance(e);var t=new b({name:"tutorial-arrow",action:R,painter:P});s.addInstance(t),s.setTimeMovement("BG_INIT_MOVEMENT",500),s.setTimeMovement("TUTORIAL_MOVEMENT",500),s.setVariable("GAME_START_NOW",!0)},s}}]);